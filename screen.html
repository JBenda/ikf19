<html>
  <head>
    <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.3.0.js"></script>
    <script type="text/javascript">
      var airconsole;
      var player;
      var canvas;
      var last = null;
      var score_el;
	  var startTime = null;
      const mProjection = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

      /**
       * Sets up the communication to game pads.
       */
      function setupConsole() {
        airconsole = new AirConsole();

        airconsole.onConnect = function(device_id) {
          checkTwoPlayers();
        };

        airconsole.onDisconnect = function(device_id) {
          var p_id = airconsole.convertDeviceIdToPlayerNumber(device_id);
          if (p_id != undefined) {
            airconsole.setActivePlayers(0);
          }
          checkTwoPlayers();
        };

        airconsole.onMessage = function(device_id, data) {
          var p_id = airconsole.convertDeviceIdToPlayerNumber(device_id);
          if (p_id != undefined && data.move !== undefined) {
			if (startTime === null) startGame();
			if (p_id === 0) player.move.x = data.move;
			else player.move.y = data.move;
          }
        };

      }

	function startGame() {
		startTime = new Date().getTime();
	}

      /**
       * Checks if two players are connected!
       */
      function checkTwoPlayers() {
        var active_players = airconsole.getActivePlayerDeviceIds();
        var connected_controllers = airconsole.getControllerDeviceIds();
        // Only update if the game didn't have active players.
        if (active_players.length == 0) {
          if (connected_controllers.length >= 2) {
            // Enough controller devices connected to start the game.
            // Setting the first 2 controllers to active players.
            airconsole.setActivePlayers(2);
            score = 0;
            score_el.innerHTML = score;
            document.getElementById("wait").innerHTML = "";
          } else if (connected_controllers.length == 1) {
            document.getElementById("wait").innerHTML = "Need 1 more player!";
          } else if (connected_controllers.length == 0) {
            document.getElementById("wait").innerHTML = "Need 2 more players!";
          }
        }
      }

      /**
       * Sends a message to the device that it should vibrate;
       */
      function vibrate(player) {
        airconsole.message(
            airconsole.convertPlayerNumberToDeviceId(player),
            { vibrate: 1000 })
      }

      /**
       * Shows who scored and updates the score afterwards.
       */
      function displayScore(score) {
		score_el.innerHTML = score.toFixed(3);
      }

      /**
       * body.onload function.
       */
      function init() {
        setupConsole();

        // Setting up the game. Nothing AirConsole specific.

        canvas = document.getElementById("canvas");
        score_el = document.getElementById("score");
        player = { pos: {x: 100, y: 50}, move: {x: 0, y: 0 }};
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
		setupProj(canvas.width, canvas.height);
        window.onresize = (clearCanvas);
        last = new Date().getTime();
        loop();
      }

      class Astroid {
			// pos = {x,y,z}, speed = {x,y,z}
			constructor(size, pos, speed) {
				this.size = size;
				this.pos = pos;
				this.speed = speed;
			}
			update(delta) {
				pos.x += speed.x * delta;
				pos.y += speed.y * delta;
				pos.z += speed.z * delta;
			}
		}
      function updatePos(entity, delta) {
        entity.pos.x += entity.move.x*delta;
        entity.pos.y += entity.move.y*delta;
      }
		const astroids = {
			update: function(delta) {
				data.forEach(function(d) { d.update(delta); });
			},
			proj: mProjection,
			add: function(obj) {this.data.push(obj);},
			draw: function(ctx, c) {
				
			},
			data: []
		};
		const astroidFactory = {
			spawn: function() {
				astroids.add(new Astroid(10, {x: 0, y: 0, z: 100}, {x: 0, y: 0, z: 10}));
			},
			astroids: astroids,
		};
       const scoreUpdate = {t: 0.1, interval: 0.1, f: function() {
			displayScore((new Date().getTime() -  startTime) * 0.001);
		}};
       const timer = [scoreUpdate];
      function loop() {
        var now = new Date().getTime();

        var delta = (now - last);
        delta = Math.min(20, delta);
        delta /= 1000.0;
        last = now;
        draw(true);
        updatePos(player, delta);
        
		if(Math.random() > 0.8) {
				astroidFactory.spawn();
		}

        timer.forEach(function(t) {
			t.t -= delta;
			if (t.t <= 0) {
				t.t = t.interval;
				if(t.f) t.f();
			}
		});

        // paddle limit
        player.pos.y = Math.min(Math.max(10, player.pos.y), 90);
		player.pos.x = Math.min(Math.max(10, player.pos.x),190);
		
        draw();

        requestAnimationFrame(loop);
      }

	function setupProj(w, h, foV = 45.0) {

	}
	
      /**
       * Reseting the ball. Nothing Game Console specific.
       * @param move_x
       * @param move_y
       */
      function clearCanvas() {
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = "black";
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
		setupProj(canvas.width, canvas.height);
        ctx.fillRect(0,0, canvas.width, canvas.height);
      }

      /**
       * Drawing the game scene. Nothing Game Console specific.
       * @param clear
       */
		var ctx = null;
      function draw(clear) {
        // Draw
		if (ctx === null)
			ctx = canvas.getContext("2d");
        var zoom = canvas.clientHeight / 100;
        function c(x) {
          x *= zoom;
          return x | 0; // round
        }
        ctx.fillStyle = clear ? 'black' : 'white';
        ctx.fillRect(c(player.pos.x - 5),c(player.pos.y - 5),
                     c(10), c(10));
		astroids.draw(ctx, c);
      }
    </script>
    <style type="text/css">
      @font-face {
        font-family: 'PressStart2P';
        src: url('PressStart2P.ttf') format('truetype');
      }

      html, body {
        height: 100%;
        margin: 0px;
        font-family: 'PressStart2P', sans-serif;
        color: white;
        text-align: center;
      }

      .game {
        background-color: black;
        top: 50%;
        margin-top: -25%;
        padding-bottom: 50%;
        overflow: hidden;
        position: relative;
      }

      #canvas {
        position: absolute;
        top: 0px;
        left:0px;
        width: 100%;
        height: 100%;
      }

      #score {
        position: absolute;
        top: 10%;
        left: 0px;
        width: 100%;
        font-size: 48px;
      }

      #wait {
        position: absolute;
        top: 10%;
        margin-top: 80px;
        left: 0px;
        width: 100%;
        font-size: 24px;
        color: lime;
      }
    </style>
  </head>
  <body onload="init()">
    <div class="game">
      <canvas id="canvas"></canvas>
      <div id="score">START</div>
      <div id="wait"></div>
    </div>
  </body>
</html>
